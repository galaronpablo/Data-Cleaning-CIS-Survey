---
title: "üë•Pr√°ctica Grupal--Encuesta CISüìë"
format: 
  html:
    theme: united
    embed-resources: true
    toc: true
    toc-location: right
    toc-title: √çndice
    toc-depth: 12
author: Hugo Alonso, Gonzalo Blanca, Pablo Galar√≥n, Ra√∫l Palomo
---

## Introducci√≥n üì¢

> Para analizar y contrastar la afirmaci√≥n recogida en la noticia de El Pa√≠s (15/01/2024), seg√∫n la cual **‚Äúun 44% de los hombres cree que se ha llegado tan lejos en la promoci√≥n de la igualdad de las mujeres que ahora se les discrimina a ellos‚Äù**, hemos seleccionado un conjunto de variables del **Estudio CIS n¬∫ 3428** que nos permitir√°n explorar tanto la percepci√≥n subjetiva de discriminaci√≥n como las condiciones objetivas de desigualdad de g√©nero.

LAS VARIABLES SELECCIONADAS SON:

-   **SEXO, EDAD, TAMUNI, INGRESHOG, SITLAB, NIVELESTENTREV, RELIGION, ESCIDEOL, ESCFEMINIS, RECUVOTOG** ‚Üí variables sociodemogr√°ficas y de contexto para analizar c√≥mo influyen el g√©nero, la edad, la clase social, la ideolog√≠a, la religiosidad y la afinidad pol√≠tica en la percepci√≥n de discriminaci√≥n.

-   **P6_2** ‚Üí pregunta central que mide si las personas creen que los hombres est√°n ahora discriminados.

-   **P4, P7_1, P7_2, P7_3** ‚Üí percepci√≥n de desigualdad real en salarios, ascensos y oportunidades laborales.

-   **TARHOGENTREV_HH, CUIDADOHIJOS_HH, HIJOMENOR** ‚Üí indicadores objetivos de reparto de tareas dom√©sticas, cuidado y carga familiar.

### Objetivo del an√°lisis üéØ

> Buscamos comprobar si quienes perciben discriminaci√≥n hacia los hombres presentan diferencias reales en:

-   reparto de tareas dom√©sticas,

-   participaci√≥n en el cuidado de hijos y personas dependientes,

-   nivel de desigualdad material y laboral que reconocen.

::: callout-note
Adem√°s, esperamos que durante el **proceso de depuraci√≥n** aparezcan evidencias que muestren si esa percepci√≥n depende m√°s de factores ideol√≥gicos (ESCIDEOL, ESCFEMINIS, RELIGION, RECUVOTOG) que de la situaci√≥n objetiva.
:::

### Hip√≥tesis iniciales üí°

> Es probable que sean **m√°s los hombres que las mujeres** quienes perciban discriminaci√≥n contra los hombres.

> Esperamos encontrar que quienes expresan esa percepci√≥n:

-   **dedican menos tiempo** al hogar y al cuidado que sus parejas mujeres,

-   **reconocen menos** desigualdad en salario y oportunidades laborales,

-   se ubican ideol√≥gicamente **m√°s a la derecha** y son **menos afines al feminismo.**

> Los factores objetivos (ingresos, hijos, tareas dom√©sticas) probablemente no expliquen esa percepci√≥n tanto como los factores ideol√≥gicos.

## Librer√≠as üìö

```{r}
library(tidyverse)
library(skimr)
library(patchwork)
library(class)
library(dbscan)
library(naniar)
library(psych)
library(VIM)
library(mice)
```

## Carga de datos y selecci√≥n de variables

> Cargamos la base de datos con read_csv2 que nos identifica el ; como delimitador.

```{r}
data_num <- read_csv2(file = "../entrega_grupal/MD3428/3428_csv/3428_num.csv") |> 
  mutate(HIJOMENOR = if_else(HIJOMENOR_99 == 1, NA, HIJOMENOR_1))
```

::: callout-important
-   Nos dimos cuenta de que la **variable original HIJOMENOR estaba mal codificada** y no reflejaba bien la realidad.
-   Por eso, usamos **HIJOMENOR_1 (si tiene hijos menores) y HIJOMENOR_99 (si respondi√≥ la pregunta)** para reconstruirla.
-   Con este c√≥digo, asignamos NA a quienes no contestaron y usamos el valor correcto de quienes s√≠ respondieron. As√≠ aseguramos que **la variable est√© limpia y lista para el an√°lisis.**
:::

> Seleccionamos las variables que hemos dicho antes.

```{r}
data_num <- data_num |> 
  select(
    SEXO,           # P0a ‚Üí Sexo
    EDAD,          # P0b ‚Üí Edad
    TAMUNI,        # Tama√±o del municipio
    INGRESHOG,     # P29 ‚Üí Ingresos del hogar
    TARHOGENTREV_HH, # Horas dedicadas al hogar (persona entrevistada)
    HIJOMENOR,    # Tiene hijos menores o no
    SITLAB,         # P28 ‚Üí Situaci√≥n laboral
    NIVELESTENTREV, # P26a ‚Üí Nivel de estudios
    P6_2,          # Opini√≥n: se discrimina a hombres
    P4,            # Grado de desigualdad en Espa√±a
    P7_1,         # Salarios mujeres vs hombres
    P7_2,         # Ascenso laboral mujeres vs hombres
    P7_3,         # Oportunidades empleo mujeres vs hombres
    ESCFEMINIS,    # Escala autodefinici√≥n feminista
    ESCIDEOL,      # Escala ideol√≥gica
    RELIGION,      # Religiosidad
    CUIDADOHIJOS_HH, # Horas cuidado hijos/as
    RECUVOTOG # Recuerdo de voto en elecciones generales
  )

```

### ¬øDe que tipo son nuestras variables?

Las variables son las siguientes:

> [**CUALITATIVAS**]{style="text-decoration: underline; text-decoration-color: red;"}

-   **SEXO** ‚Üí cualitativa nominal (sexo del entrevistado)

-   **TAMUNI** ‚Üí cualitativa ordinal (tama√±o del municipio)

-   **INGRESHOG** ‚Üí cualitativa ordinal (ingresos del hogar)

-   **HIJOMENOR** ‚Üí cualitativa nominal (si tiene hijos/as menores)

-   **SITLAB** ‚Üí cualitativa nominal (situaci√≥n laboral)

-   **NIVELESTENTREV** ‚Üí cualitativa nominal (nivel de estudios)

-   **GRADACDISC(p6_2)** ‚Üí cualitativa ordinal (grado de acuerdo de la afirmaci√≥n)

-   **GRADODESIGUALDAD(p4)** ‚Üí cualitativa ordinal (grado de desigualdad percibida entre hombres y mujeres en Espa√±a)

-   **VALSALARIOS(p7_1)** ‚Üí cualitativa ordinal (valoraci√≥n de la situaci√≥n de las mujeres respecto de los hombres en los salarios)

-   **VALPOSASC(p7_2)** ‚Üí cualitativa ordinal (valoraci√≥n de la situaci√≥n de las mujeres respecto de los hombres en las posibilidades de ascenso en el trabajo)

-   **VALOPEMP(p7_3)** ‚Üí cualitativa ordinal (valoraci√≥n de la situaci√≥n de las mujeres respecto de los hombres en las oportunidades para encontrar empleo)

-   **RELIGION** ‚Üí cualitativa nominal (religi√≥n declarada)

-   **RECUVOTOG** ‚Üí cualitativa nominal (recuerdo de voto)

> [**CUANTITATIVAS**]{style="text-decoration: underline; text-decoration-color: red;"}

-   **EDAD** ‚Üí cuantitativa discreta (edad en a√±os)

-   **TARHOGENTREV_HH** ‚Üí cuantitativa discreta (horas dedicadas al hogar)

-   **ESCFEMINIS** ‚Üí cuantitativa discreta (escala sobre feminismo 0‚Äì10)

-   **ESCIDEOL** ‚Üí cuantitativa discreta (escala ideol√≥gica 0‚Äì10)

-   **CUIDADOHIJOS_HH** ‚Üí cuantitativa discreta (horas dedicadas al cuidado de hijos)

## Recodificaci√≥n de las variables ‚ôªÔ∏è

> Este proceso es clave porque, si lo hacemos bien ahora, nos ahorrar√° mucho tiempo y problemas en el an√°lisis posterior.

### NS/NS/NO PROCEDE -\>\> NA

> En este paso calculamos el **porcentaje de respuestas ‚ÄúNo sabe / No contesta‚Äù** para cada variable y, al comprobar que es bajo, las recodificamos como NA. Esto limpia la base de datos y nos permite trabajar solo con respuestas v√°lidas en los an√°lisis posteriores.

::: callout-note
Hemos **tenido en cuenta el significado de cada variable** para decidir si recodificar las respuestas ‚ÄúNo sabe / No contesta‚Äù como NA o mantenerlas como una categor√≠a v√°lida. Por ejemplo, en **RECUVOTOG, nos interesa conservar el ‚ÄúNo contesta‚Äù** como categor√≠a analizable, mientras que el ‚ÄúNo recuerda‚Äù lo recodificamos como NA porque no aporta informaci√≥n √∫til al an√°lisis.
:::

```{r}
variables_analizar <- c(
  "SEXO", "EDAD", "TAMUNI", "INGRESHOG", "TARHOGENTREV_HH",
  "HIJOMENOR", "SITLAB", "NIVELESTENTREV", "P6_2", "P4", "P7_1", "P7_2",
  "P7_3", "ESCFEMINIS", "ESCIDEOL", "RELIGION", "CUIDADOHIJOS_HH", "RECUVOTOG"
)

# Recorremos cada variable y mostramos proporciones
for (var in variables_analizar) {
  cat("\nVariable:", var, "\n")
  print(prop.table(table(data_num[[var]])))
}
```

```{r}
data_num <- data_num |> 
  mutate(
    INGRESHOG = ifelse(INGRESHOG %in% c(8, 9), NA, INGRESHOG),
    TARHOGENTREV_HH = ifelse(TARHOGENTREV_HH %in% c(98, 99), NA, TARHOGENTREV_HH),
    SITLAB = ifelse(SITLAB == 9, NA, SITLAB),
    NIVELESTENTREV = ifelse(NIVELESTENTREV %in% c(98, 99), NA, NIVELESTENTREV),
    P6_2 = ifelse(P6_2 %in% c(8, 9), NA, P6_2),
    P4 = ifelse(P4 %in% c(8, 9), NA, P4),
    P7_1 = ifelse(P7_1 %in% c(8, 9), NA, P7_1),
    P7_2 = ifelse(P7_2 %in% c(8, 9), NA, P7_2),
    P7_3 = ifelse(P7_3 %in% c(8, 9), NA, P7_3),
    ESCFEMINIS = ifelse(ESCFEMINIS %in% c(98, 99), NA, ESCFEMINIS),
    ESCIDEOL = ifelse(ESCIDEOL %in% c(98, 99), NA, ESCIDEOL),
    RELIGION = ifelse(RELIGION == 9, NA, RELIGION),
    CUIDADOHIJOS_HH = ifelse(CUIDADOHIJOS_HH %in% c(96, 98, 99), NA, CUIDADOHIJOS_HH), #TENER EN CUENTA EL 16 PARA FUTUROS AN√ÅLISIS, depende de si responde que tiene hijos o no, var hijomenor
    RECUVOTOG = ifelse(RECUVOTOG == 9998, NA, RECUVOTOG)
  )
```

::: callout-important
-   En el an√°lisis observamos que el **valor 96** tiene un porcentaje muy alto en la variable **CUIDADOSHIJOS_HH**, pero aun as√≠ decidimos recodificarlo como NA. Esto se debe a que este valor representa a personas que no tienen hijos, por lo que la variable depende directamente de HIJOMENOR. **Cuando trabajemos con esta variable en an√°lisis futuros, no vamos a imputar los NA; en su lugar, filtraremos los datos usando la variable HIJOMENOR** para asegurarnos de incluir solo los casos relevantes.

-   Sucede lo mismo con la variable RECUVOTOG, donde el 0 significa los que no tenemos info de su voto, pero en vez de pasarlo a na nos creamos un tipo nuevo porque tenemos la suerte de que es cualitativa y no afecta igual que con las cuantitativas.
:::

### Conversi√≥n a factores con labels

> Recodificamos las variables cualitativas. Las variables P..., las ponemos un nombre acorde a su significado.

```{r}
data_num <- 
  data_num |> 
  rename(GRADACDISC = P6_2,
         GRADODESIGUALDAD = P4,
         VALSALARIOS = P7_1,
         VALPOSASC = P7_2,
         VALOPEMP = P7_3)
```

```{r}
data_num <- data_num |> 
  mutate(
    SEXO = factor(SEXO, levels = c(1, 2), labels = c("Hombre", "Mujer")),  # nominal
    TAMUNI = factor(TAMUNI, 
                levels = 7:1, 
                labels = c(">1000000 habitantes", 
                           "400001-1000000 habitantes", 
                           "100001-400000 habitantes", 
                           "50001-100000 habitantes", 
                           "10001-50000 habitantes", 
                           "2001-10000 habitantes", 
                           "‚â§2000 habitantes"),
                ordered = TRUE),  # ordinal
    INGRESHOG = factor(INGRESHOG, levels = 1:6,
                       labels = c("M√°s de 5000‚Ç¨", 
                                  "3901-5000‚Ç¨", 
                                  "2701-3900‚Ç¨", 
                                  "1801-2700‚Ç¨", 
                                  "1100-1800‚Ç¨", 
                                  "Menos de 1100‚Ç¨"),
                       ordered = TRUE),  # ordinal
    HIJOMENOR = factor(HIJOMENOR, levels = c(1, 2),
                       labels = c("Tiene hijos/as menores", "Ninguno")), # nominal 
    SITLAB = factor(SITLAB, levels = 1:8,
                    labels = c("Trabaja", 
                               "Jubilado/a o pensionista (ha trabajado)", 
                               "Pensionista (no ha trabajado)", 
                               "En paro, ha trabajado antes", 
                               "En paro, busca primer empleo", 
                               "Estudiante", 
                               "Trabajo dom√©stico no remunerado", 
                               "Otra situaci√≥n")),  # nominal
    NIVELESTENTREV = factor(NIVELESTENTREV, levels = 1:16,
                            labels = c("Menos de 5 a√±os escolarizaci√≥n", 
                                       "Primaria", 
                                       "FP b√°sica", 
                                       "Educaci√≥n secundaria", 
                                       "FP grado medio", 
                                       "Bachillerato", 
                                       "FP grado superior", 
                                       "Arquitectura/ingenier√≠a t√©cnica", 
                                       "Diplomaturas oficiales", 
                                       "Grado universitario", 
                                       "Licenciatura", 
                                       "Arquitectura/ingenier√≠a", 
                                       "M√°ster oficial", 
                                       "Doctorado", 
                                       "T√≠tulos propios posgrado", 
                                       "Otros estudios")),  # nominal
    GRADACDISC = factor(GRADACDISC, 
                      levels = 5:1, 
                      labels = c("Nada de acuerdo", 
                                 "Poco de acuerdo", 
                                 "Regular", 
                                 "Bastante de acuerdo", 
                                 "Muy de acuerdo"),
                      ordered = TRUE),  # ordinal
    GRADODESIGUALDAD = factor(GRADODESIGUALDAD, 
                          levels = 4:1, 
                          labels = c("Casi inexistentes", 
                                     "Peque√±as", 
                                     "Bastante grandes", 
                                     "Muy grandes"),
                          ordered = TRUE),  # ordinal
    VALSALARIOS = factor(VALSALARIOS, levels = 3:1,
                            labels = c("Peor", "Igual", "Mejor"),
                            ordered = TRUE),  # ordinal
    VALPOSASC = factor(VALPOSASC, levels = 3:1,
                          labels = c("Peor", "Igual", "Mejor"),
                          ordered = TRUE),  # ordinal
    VALOPEMP = factor(VALOPEMP, levels = 3:1,
                         labels = c("Peor", "Igual", "Mejor"),
                         ordered = TRUE),  # ordinal
    RELIGION = factor(RELIGION,  levels = 1:6,
                      labels = c("Cat√≥lico/a practicante", 
                                 "Cat√≥lico/a no practicante", 
                                 "Creyente de otra religi√≥n", 
                                 "Agn√≥stico/a", 
                                 "Indiferente, no creyente", 
                                 "Ateo/a")),  # nominal
    RECUVOTOG = factor(RECUVOTOG, levels = c(1, 2, 3, 6, 21, 503, 901, 902, 1201, 1501, 1601, 1602,
             8995, 8996, 9977, 9999),
  labels = c(
    'PSOE (PSC, PSE-EE, PSdeG, PSIB, PSN)',
    'PP',
    'VOX',
    'PACMA',
    'SUMAR (Podemos, IU, M√°s Pa√≠s, etc.)',
    'CCa (Coalici√≥n Canaria)',
    'ERC (Esquerra Republicana)',
    'JUNTS (Junts per Catalunya)',
    'BNG (Bloque Nacionalista Galego)',
    'UPN (Uni√≥n del Pueblo Navarro)',
    'EAJ-PNV (Partido Nacionalista Vasco)',
    'EH Bildu (Euskal Herria Bildu)',
    'Otro partido',
    'En blanco',
    'Voto nulo',
    'N.C.'))  # nominal
  )
```

-   Comprobamos

```{r}
data_num |>  distinct(SEXO)
data_num |>  distinct(TAMUNI)
data_num |>  distinct(INGRESHOG)
data_num |>  distinct(HIJOMENOR) 
data_num |>  distinct(SITLAB)
data_num |>  distinct(NIVELESTENTREV)
data_num |>  distinct(GRADACDISC)
data_num |>  distinct(GRADODESIGUALDAD)
data_num |>  distinct(VALSALARIOS)
data_num |>  distinct(VALPOSASC)
data_num |>  distinct(VALOPEMP)
data_num |>  distinct(RELIGION)
data_num |>  distinct(RECUVOTOG)
```

```{r}
str(data_num)
```

‚úÖ **COMPROBADO, BIEN RECODIFICADAS**

## Errores ‚ö†Ô∏è

> Las variables **cualitativas est√°n correctamente codificadas.** Sin embargo, en las continuas detectamos anomal√≠as en TARHOGENTREV_HH y CUIDADOSHIJOS_HH.

```{r}
summary(data_num)
```

-   **TARHOGENTREV_HH(horas dedicadas a tareas del hogar)**: presenta un valor m√°ximo de 24, lo que implicar√≠a dedicar todo el d√≠a a estas tareas, algo **poco realista.** Este valor se aleja mucho de la media (2,41), la mediana (2) y el tercer cuartil (3).

```{r}
ggplot(data_num) +
  geom_bar(aes(x = TARHOGENTREV_HH), fill = '#17becf', alpha = 0.8 ) +
  labs(title = 'Distribuci√≥n variable TARHOGENTREV_HH') +
  theme_minimal()
```

El histograma muestra que la gran mayor√≠a dedica entre 0 y 5 horas a tareas del hogar y valor m√°ximo de 24h esta aislado y sin continuidad en la distribuci√≥nEste dato es poco plausible, por lo que seguramente se trate de un error, asi que vamos a pasarlo a NA directamente.

```{r}
data_num <- 
  data_num |> 
  mutate(TARHOGENTREV_HH = ifelse(TARHOGENTREV_HH == 24, NA, TARHOGENTREV_HH))
```

-   **CUIDADOHIJOS_HH(horas dedicadas al cuidado de los hijos)**: tambi√©n tiene un m√°ximo de 24, pero en este caso es plausible, especialmente en familias **con reci√©n nacidos**. No obstante, sigue siendo un valor extremo frente a la media (5,16), la mediana (4) y el tercer cuartil (6).

```{r}
  ggplot(data_num) +
    geom_bar(aes(x = CUIDADOHIJOS_HH), fill = '#17becf', alpha = 0.8 ) +
    labs(title = 'Distribuci√≥n variable CUIDADOSHIJOS_HH') +
    theme_minimal()
```

En este caso, los valores de 24 h podr√≠an formar parte natural de la distribuci√≥n, que muestra una clara cola derecha. A diferencia del caso anterior, no es un valor aislado, sino una respuesta que se repite. Por ello, no lo consideraremos un error y lo mantendremos, aunque lo tendremos en cuenta en futuros an√°lisis.

## Detecci√≥n de outliers üîç

### Univariante

> Aplicamos la funci√≥n que nos calcula los valores at√≠picos y extremos.

```{r}
source("Funcion_atipicos.R")

numeric_integer_vars <- names(which(sapply(data_num, is.numeric) | sapply(data_num, is.integer)))
# Aplicar la funci√≥n 'outliers' a cada una de las variables num√©ricas
outliers_results <- lapply(numeric_integer_vars, function(var) {
  outliers(data_num, var)  # Llamar a la funci√≥n pasando el nombre de la variable
})
```

‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è

-   Mirando los boxplots, observamos que las variables **TARHOGENTREV_HH, ESCFEMINIS y CUIDADOHIJOS_HH** presentan datos que podr√≠an considerarse at√≠picos. Sin embargo, antes de clasificarlos directamente como tales, es importante analizar **si realmente lo son.**

-   Para ello, comenzaremos revisando los histogramas de cada variable, ya que es posible que esos valores simplemente **formen parte de una distribuci√≥n asim√©trica** y no correspondan necesariamente a anomal√≠as. Adem√°s, analizaremos los **porcentajes de casos que representan esos valores ‚Äúat√≠picos‚Äù** dentro de la base de datos, para valorar si, por su peso relativo, pueden considerarse **datos t√≠picos** del conjunto. Vamos a mirarlo variable por variable.

-   No obstante, corroboraremos nuestras hip√≥tesis del univariante al hacer el an√°lisis multivariante y ya tomar la decisi√≥n de que hacer con ellos.

::: panel-tabset
#### Variable TARHOGENTREV_HH

üìå Outliers identified in TARHOGENTREV_HH : 115 outliers üìä Proportion (%) of outliers: 3.03 %

üö® Extreme values identified in TARHOGENTREV_HH : 40 extreme values üìä Proportion (%) of extreme values: 1.05 %

-   **Vamos a cuantificarlos**

```{r}
#outliers
outlier_values_th <- boxplot.stats(data_num$TARHOGENTREV_HH)$out 
outlier_values_th

out_ind_th <- which(data_num$TARHOGENTREV_HH %in% c(outlier_values_th))
out_ind_th

#extremos
extreme_values_th <- boxplot.stats(data_num$TARHOGENTREV_HH,coef=3)$out
extreme_values_th

ext_ind_th <- which(data_num$TARHOGENTREV_HH %in% c(extreme_values_th))
ext_ind_th
```

-   El porcentaje de at√≠picos es del 3,03% y de extremos del 1,05%, lo cual entra dentro del rango que suele considerarse aceptable (entre un 2% y un 5%), aunque no conviene aplicar esta regla de forma autom√°tica. Si miramos el histograma, vemos que los outliers est√°n entre 7 y 10 horas, mientras que los extremos van de 10 a 18 horas. Teniendo en cuenta que la variable mide el n√∫mero de horas dedicadas al hogar, a partir de unas 12 horas ya podr√≠amos decir que es bastante inusual.

-   En el histograma se nota claramente que los extremos est√°n muy lejos del resto de los datos, lo que hace pensar que ser√≠a buena idea apartarlos o quitarlos del an√°lisis. En cambio, los outliers, aunque altos, parecen formar parte de la cola natural de la distribuci√≥n y probablemente reflejen simplemente que algunas personas dedican mucho m√°s tiempo al hogar. Adem√°s, siendo un 3,03% frente al 1,05% de los extremos, parece razonable quedarse con los outliers, ya que dedicar entre 7 y 10 horas puede ser mucho, pero no algo s√∫per exagerado. 

-   No obstante, tendremos esto en cuenta pero tomaremos la decisi√≥n final en el an√°lisis bivariante. Si no encontramos asociaci√≥n con ninguna variable, al ser el porcentaje relativamente bajo, nos desprenderemos de ellos.

![](images/clipboard-140032520.png){width="587"}

#### Variable ESCFEMINIS

üìå Outliers identified in ESCFEMINIS : 346 outliers üìä Proportion (%) of outliers: 8.77 %

üö® Extreme values identified in ESCFEMINIS : 0 extreme values üìä Proportion (%) of extreme values: 0 %

-   **Vamos a cuantificarlos**

```{r}
#outliers
outlier_values_f <- boxplot.stats(data_num$ESCFEMINIS)$out 
outlier_values_f

out_ind_f <- which(data_num$ESCFEMINIS %in% c(outlier_values_f))
out_ind_f

#extremos
extreme_values_f <- boxplot.stats(data_num$ESCFEMINIS,coef=3)$out
extreme_values_f

ext_ind_f <- which(data_num$ESCFEMINIS %in% c(extreme_values_f))
ext_ind_f
```

-   En esta variable no encontramos valores extremos, aunque s√≠ aparece un porcentaje relativamente alto de outliers, con un 8,77%. La variable mide en una escala del 0 al 10 el nivel de feminismo percibido, donde 0 es ‚Äúnada feminista‚Äù y 10 es ‚Äúmuy feminista‚Äù, preguntando a las personas d√≥nde se ubican. Vemos que todos los outliers se concentran en el valor 0, lo cual es bastante interesante porque probablemente est√© relacionado con alguna otra variable, ya que si miramos el histograma, la barra del 0 es igual de alta que muchas otras y no destaca visualmente como algo raro.

-   Viendo el alto porcentaje y que todos corresponden al cero, parece haber una asociaci√≥n y no vamos a tener que quitarlos, en el bivariante veremos.

    ![](images/clipboard-18049767.png){width="574"}

#### Variable CUIDADOHIJOS_HH

üìå Outliers identified in CUIDADOHIJOS_HH : 67 outliers üìä Proportion (%) of outliers: 6.69 %

üö® Extreme values identified in CUIDADOHIJOS_HH : 35 extreme values üìä Proportion (%) of extreme values: 3.49 %

-   **Vamos a cuantificarlos**

```{r}
#outliers
outlier_values_ch <- boxplot.stats(data_num$CUIDADOHIJOS_HH)$out 
outlier_values_ch

out_ind_ch <- which(data_num$CUIDADOHIJOS_HH %in% c(outlier_values_ch))
out_ind_ch

#extremos
extreme_values_ch <- boxplot.stats(data_num$CUIDADOHIJOS_HH,coef=3)$out
extreme_values_ch

ext_ind_ch <- which(data_num$CUIDADOHIJOS_HH %in% c(extreme_values_ch))
ext_ind_ch
```

-   En esta variable tenemos un 6,69% de outliers y un 3,49% de extremos, lo que ya empieza a salirse un poco del rango t√≠pico del 2-5%. La variable mide el n√∫mero de horas dedicadas al cuidado de los hijos en el hogar, y cuando miramos los datos vemos valores altos como 13, 16, 20 y hasta 24 horas. Si pensamos en hogares con reci√©n nacidos o beb√©s, tiene todo el sentido que se reporten valores tan elevados, porque b√°sicamente alguien est√° pendiente de ellos casi las 24 horas del d√≠a.

-   Adem√°s, estos valores parecen formar parte de una distribuci√≥n asim√©trica, donde la cola se alarga hacia la derecha con esas horas tan altas. Por eso, nosotros de momento no los quitar√≠amos, ya que reflejan una situaci√≥n real y relevante, aunque lo ideal ser√° mirarlo m√°s a fondo en el an√°lisis bivariante para ver si realmente tienen un impacto importante o si est√°n relacionados con otras variables.

    ![](images/clipboard-1921889874.png){width="593"}
:::

### Bivariante

>En esta parte vamos a ir gr√°fico por gr√°fico para ver si los posibles outliers que detectamos antes forman parte de alguna asociaci√≥n entre variables. La idea es ver si esos valores extremos tienen sentido dentro de un patr√≥n m√°s amplio o si realmente se salen por completo y hay que quitarlos.

:::callout-warning
Vamos a hacer los gr√°ficos solo para cualitativas porque para cuaanti vs cuanti salen muy mal ya que las variables son cuantitativas discretas. Un ejemplo de lo que comentamos:

```{r}
ggplot(data_num,aes(CUIDADOHIJOS_HH, TARHOGENTREV_HH)) + 
  geom_point() +
  stat_smooth(method = "lm",formula = y ~ x,geom = "smooth")
```

No hay por donde cogerlo.
:::


:::panel-tabset

#### Variable TARHOGENTREV_HH

```{r}
ggplot(data_num, aes(x = SEXO, y = TARHOGENTREV_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = TAMUNI, y = TARHOGENTREV_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = INGRESHOG, y = TARHOGENTREV_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = SITLAB, y = TARHOGENTREV_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = GRADACDISC, y = TARHOGENTREV_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = GRADODESIGUALDAD, y = TARHOGENTREV_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

>Los valores extremos de la variable TARHOGENTREV_HH no pueden explicarse claramente mediante ninguna de las variables categ√≥ricas analizadas. Aparecen de forma dispersa en todos los grupos, aunque algunas variables como situaci√≥n laboral o percepci√≥n de desigualdad muestran ligeras asociaciones, **pero no suficientes para justificar los valores at√≠picos m√°s altos.**

- Hemos decidido tratar los valores extremos de la variable TARHOGENTREV_HH para que no distorsionen los an√°lisis. En total detectamos 115 outliers, pero solo 40 eran realmente extremos, porque estaban muy por encima de lo normal (m√°s all√° de Q3 + 3¬∑IQR). En lugar de eliminarlos todos o inventar valores, lo que hicimos fue reemplazar solo esos 40 casos por NA. **DEJAMOS OUTLIERS Y QUITAMOS EXTREMOS.** 

:::callout-note
- Los vamos a quitar despu√©s del LOF ya que si los pasamos a na antes, el lof quita los na y no nos selecciona los datos puros.
:::

Observar donde exactamente est√°n nuestros outliers nos sirve para ver estas relaciones m√°s claras.

```{r}
data_num[out_ind_th, ]
```

```{r}
data_num[ext_ind_th, ]
```

#### Variable ESCFEMINIS

```{r}
ggplot(data_num, aes(x = SEXO, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = GRADACDISC, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = GRADODESIGUALDAD, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = VALSALARIOS, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = VALPOSASC, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = VALOPEMP, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_num, aes(x = RECUVOTOG, y = ESCFEMINIS)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

>Los valores at√≠picos de 0 en la variable ESCFEMINIS (escala de autodefinici√≥n feminista) **no parecen ser errores de codificaci√≥n, sino respuestas intencionadas y coherentes por parte de ciertos perfiles ideol√≥gicos.** Al analizar su asociaci√≥n con otras variables, observamos patrones claros que eran los que ya veniamos intuyendo en nuestras hip√≥tesis iniciales.

- **RECUVOTOG (recuerdo de voto)**: La gran mayor√≠a de estos valores extremos se concentran entre personas que afirman **haber votado a VOX**, un partido que habitualmente se posiciona de forma cr√≠tica frente al feminismo. 

- **GRADODESIGUALDAD (grado de desigualdad percibida)**: Los valores bajos en ESCFEMINIS suelen darse entre quienes **creen que las desigualdades de g√©nero en Espa√±a son peque√±as o casi inexistentes.** Esto tiene sentido, ya que si no se percibe desigualdad, es menos probable que una persona se autodefina como feminista.

- **GRADACDISC (grado de acuerdo con la afirmaci√≥n de que se discrimina a los hombres)**: Aqu√≠ tambi√©n se ve una relaci√≥n esperada: quienes m√°s de acuerdo est√°n con esta afirmaci√≥n tienden a tener puntuaciones m√°s bajas en la escala feminista. 

- **VALSALARIOS, VALPOSASC y VALOPEMP (valoraciones sobre si las mujeres est√°n en peor situaci√≥n en salarios, ascensos y empleo)**: Los valores de ESCFEMINIS m√°s bajos se asocian con quienes creen que la situaci√≥n de mujeres y hombres es igual o incluso mejor para ellas. Esto tambi√©n es l√≥gico: si se percibe que no existe desventaja, es menos probable que se adopte una postura feminista.

- **SEXO**: Aunque hay alg√∫n valor 0 tanto en hombres como mujeres, son mucho **m√°s frecuentes entre hombres.**

:::callout-important
Por tanto, no los eliminamos, nos los quedamos, porque sino estar√≠amos eliminando algo clave que nos ayuda a rebatir el objetivo que tenemos de desmentir la afirmaci√≥n que sale en El Pa√≠s. Adem√°s el porentaje era bastante elevado
:::

Observar donde exactamente est√°n nuestros outliers nos sirve para ver estas relaciones m√°s claras.

```{r}
data_num[out_ind_f, ]
```

```{r}
#no hay
data_num[ext_ind_f, ]
```

#### Variable CUIDADOHIJOS_HH

```{r}
ggplot(data_num, aes(x = SEXO, y = CUIDADOHIJOS_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(data_num, aes(x = SITLAB, y = CUIDADOHIJOS_HH)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

>Al mirar la variable CUIDADOHIJOS_HH comparada con el resto, vemos que en la **mayor√≠a de los casos no parece haber una relaci√≥n clara.** Pero cuando la comparamos con la situaci√≥n laboral (SITLAB), s√≠ que aparece una cierta asociaci√≥n. Esto nos hace pensar que esa variable forma parte del comportamiento general de los datos, y por tanto, podr√≠amos estar ante una distribuci√≥n asim√©trica.

- Por eso, de momento no la vamos a eliminar, aunque m√°s adelante, cuando hagamos el an√°lisis con el m√©todo LOF, podr√≠a que nos indique que s√≠ deber√≠amos quitarla si se comporta como un valor at√≠pico.

Observar donde exactamente est√°n nuestros outliers nos sirve para ver estas relaciones m√°s claras.

```{r}
data_num[out_ind_ch, ]
```

```{r}
data_num[ext_ind_ch, ]
```

:::

## Detecci√≥n y tratamiento Multivariante (LOF) ‚öôÔ∏è

>**LOF** es un algoritmo de detecci√≥n de valores at√≠picos basado en la **proximidad y la densidad.**

>LOF se centra en encontrar observaciones que se desv√≠en del patr√≥n de densidad local. Es decir, **modela los valores at√≠picos como puntos que est√°n aislados de los datos restantes.** En la pr√°ctica, la densidad local se obtiene de los k vecinos m√°s cercanos.

::: callout-warning
- Cuidado, este algoritmo detecta **‚ÄúObservaciones at√≠picas‚Äù(filas enteras) no ‚Äúdatos at√≠picos‚Äù(Datos sueltos individuales)** considerando m√∫ltiples variables al mismo tiempo.

- Es independiente a lo que acabamos de hacer pero **nos puede ayudar a corregir previos fallos** por ejemplo si no hemos detectado unos ouliers, alomejor el algoritmo nos recalca que est√°n haciendo raras sus observaciones.
:::

- No podemos aplicar el LOF con NA's, vemos los nas que tenemos.
```{r}
#paquete skimr
data_num |> skim()
```

- Vemos que la variable de hijos tiene 3003 nas, no podemos quitarnosla y continuar porque nos quitamos un muy alto porcentaje de la base de datos. Vamos a realizar 2 an√°lisis LOF, uno quitando esa variable y otro incluyendola.

### LOF SIN HIJOS

:::panel-tabset

#### Aplicamos la funci√≥n

- Filtramos las variables y quitamos los nas.
```{r}
data_num_sin <- 
  data_num |> 
  select(EDAD, TARHOGENTREV_HH, ESCFEMINIS, ESCIDEOL) |> 
  drop_na()
```

```{r}
k <- round(log(nrow(data_num_sin)))
lof_resultados <- lof(data_num_sin, minPts = k) 

lof_resultados
```

#### LOF \>1,5

```{r}
data_num_sin$lof <- lof_resultados #a√±adimos la variable lof al conjunto de datos original


# Los que tienen un LOF mayor de 1.5
lof_significativos <- 
  data_num_sin |> 
  filter(lof > 1.5) |> 
  relocate(lof, .before = "EDAD") #para que se pueda observar bien en el html

lof_significativos
```

#### Boxplot de LOF

```{r}
ggplot(data_num_sin, aes(y = lof)) +
  geom_boxplot(fill = "skyblue", outlier.color = "red", outlier.shape = 16) +
  theme_minimal() +
  labs(title = "Distribuci√≥n de LOF Scores")
```

```{r}
min(lof_significativos$lof)
max(lof_significativos$lof)
```


#### Gr√°fico de puntuaci√≥n LOF

>Este gr√°fico es √∫til para entender c√≥mo se distribuyen los outliers en dos variables, pero no refleja todo el an√°lisis de LOF. LOF funciona en el espacio multidimensional, considerando todas las variables al mismo tiempo. Para poder visualizarlo vamos a dejar una variable fija y a representarla de manera bidimensional con el resto de variables(en este caso solo tenemos 4 cuantitativas).

```{r}
#las cuantitativas
ggplot(data_num_sin, aes(x = TARHOGENTREV_HH, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")

ggplot(data_num_sin, aes(x = ESCIDEOL, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")

ggplot(data_num_sin, aes(x = EDAD, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")
```

La escala de color me muestra los LOF M√ÅS significativos que ahora comentaremos.

:::

### LOF CON HIJOS

:::panel-tabset

#### Aplicamos la funci√≥n

- Filtramos las variables y quitamos los nas.
```{r}
data_num_con <- 
  data_num |> 
  select(EDAD, TARHOGENTREV_HH, ESCFEMINIS, ESCIDEOL, CUIDADOHIJOS_HH) |> 
  drop_na()
```


```{r}
k <- round(log(nrow(data_num_con)))
lof_resultados_2 <- lof(data_num_con, minPts = k) 

lof_resultados_2
```

#### LOF \>1,5

```{r}
data_num_con$lof <- lof_resultados_2 #a√±adimos la variable lof al conjunto de datos original


# Los que tienen un LOF mayor de 1.5
lof_significativos_2 <- 
  data_num_con |> 
  filter(lof > 1.5) |> 
  relocate(lof, .before = "EDAD") #para que se pueda observar bien en el html

lof_significativos_2
```

#### Boxplot de LOF

```{r}
ggplot(data_num_con, aes(y = lof)) +
  geom_boxplot(fill = "skyblue", outlier.color = "red", outlier.shape = 16) +
  theme_minimal() +
  labs(title = "Distribuci√≥n de LOF Scores")
```

```{r}
min(lof_significativos_2$lof)
max(lof_significativos_2$lof)
```


#### Gr√°fico de puntuaci√≥n LOF

>Este gr√°fico es √∫til para entender c√≥mo se distribuyen los outliers en dos variables, pero no refleja todo el an√°lisis de LOF. LOF funciona en el espacio multidimensional, considerando todas las variables al mismo tiempo. Para poder visualizarlo vamos a dejar una variable fija y a representarla de manera bidimensional con el resto de variables(en este caso solo tenemos 4 cuantitativas).

```{r}
#las cuantitativas
ggplot(data_num_con, aes(x = EDAD, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")

ggplot(data_num_con, aes(x = TARHOGENTREV_HH, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")

ggplot(data_num_con, aes(x = ESCIDEOL, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")

ggplot(data_num_con, aes(x = CUIDADOHIJOS_HH, y = ESCFEMINIS, colour = lof)) +
  geom_point() +
  scale_color_gradient(low = "blue", high = "red", name = "LOF Score") +
  labs(title = "Detecci√≥n de Valores At√≠picos con LOF")
```

La escala de color me muestra los LOF M√ÅS significativos que ahora comentaremos.

:::

### Conclusiones LOF 

>Aunque el algoritmo LOF ha detectado algunas observaciones con puntuaciones por encima de 1.5, en ambos an√°lisis (con y sin la variable de cuidado de hijos/as), los valores se mantienen dentro de un rango moderado, **movi√©ndose entre 1.5 y algo m√°s de 2.**

```{r}
#sin hijos
min(lof_significativos$lof)
max(lof_significativos$lof)

#con hijos
min(lof_significativos_2$lof)
max(lof_significativos_2$lof)
```


- Esto significa que, si bien hay observaciones que se alejan ligeramente del patr√≥n general, **no encontramos casos extremos que se desmarquen claramente del resto.** Por tanto, no consideramos que haya observaciones at√≠picas graves que deban ser eliminadas.

- En vez de eliminar todo lo que supere el umbral de 1.5, lo que hemos hecho es observar cu√°les se separan mucho del resto, y al ver que no hay grandes saltos, decidimos mantener todos los casos, ya que aportan informaci√≥n √∫til.

```{r}
#sin hijos
lof_significativos

#con hijos
lof_significativos_2
```

**Aunque no veamos una distancia muy grande entre los valores LOF, vemos que los valores m√°s altos de LOF corresponden a los valores de los extremos de la variable TARHOGARENTREV_HH, la cual hemos decidido que los vamos a quitar. El lof ha sido capaz de corroborar las hip√≥tesis que hemos sacado en el bivariante. Pero no quitaremos toda la observaci√≥n porque hemos identificado los valores que la est√°n haciendo rara, quitamos esos valores y ya.**

:::callout-important
- Una vez hecho este proceso podemos ya quitar los extremos detectados en el bivariante y confirmados en el lof, los pasamos a na.

```{r}
data_num <- 
  data_num |> 
  mutate(TARHOGENTREV_HH = if_else(TARHOGENTREV_HH >= 10, NA, TARHOGENTREV_HH))
```
:::

## Tratamiento de Ausentes üß©

### An√°lisis inicial

- Gr√°ficamente
```{r}
gg_miss_var(data_num, show_pct = TRUE)
vis_miss(data_num)
```

- Cuantificamos
```{r}
n_miss(data_num)
pct_miss(data_num)
pct_complete_case(data_num)
```

:::callout.warning
Este an√°lisis muestra que **solo un 18% de los casos est√°n completos**, es decir, sin ning√∫n valor perdido. Eso significa que si nos quedamos solo con los casos completos, perder√≠amos m√°s del 80% de los datos, lo cual es una barbaridad. Por eso, la imputaci√≥n es clave
:::

### An√°lisis de cualitativas

#### Visualizamos

```{r}
#Sexo
gg_miss_var(data_num, show_pct = TRUE, facet = SEXO)

#TAMUNI
gg_miss_var(data_num, show_pct = TRUE, facet = TAMUNI)

#INGRESHOG
gg_miss_var(data_num, show_pct = TRUE, facet = INGRESHOG)

#HIJOMENOR
gg_miss_var(data_num, show_pct = TRUE, facet = HIJOMENOR)

#SITLAB
gg_miss_var(data_num, show_pct = TRUE, facet = SITLAB)

#NIVELESTENTREV
gg_miss_var(data_num, show_pct = TRUE, facet = NIVELESTENTREV)

#GRADACDISC
gg_miss_var(data_num, show_pct = TRUE, facet = GRADACDISC)

#GRADODESIGUALDAD
gg_miss_var(data_num, show_pct = TRUE, facet = GRADODESIGUALDAD)

#VALSALARIOS
gg_miss_var(data_num, show_pct = TRUE, facet = VALSALARIOS)

#VALPOSASC
gg_miss_var(data_num, show_pct = TRUE, facet = VALPOSASC)

#VALOPEMP
gg_miss_var(data_num, show_pct = TRUE, facet = VALOPEMP)

#RELIGION
gg_miss_var(data_num, show_pct = TRUE, facet = RELIGION)

#RECUVOTOG
gg_miss_var(data_num, show_pct = TRUE, facet = RECUVOTOG)
```

- Hemos detectado que la **variable recuvotog es mnar ya que muestra una asociaci√≥n pero no sabemos explicarla del todo.** Adem√°s si nos fijamos vemos que hay muchos m√°s missings de los que deber√≠a haber si solo hubiesemos pasados a nas "no recuerda". Esto se debe a que el valor cero en esa variable cosrresponde a todos los que no hab√≠an votado y no ven√≠a especificada en el pdf de las etiquetas y el cuestionario, por lo que en el factor se han ido a nas. 

:::callout-note
- Un mnar depende de variables "ocultas" en los datos que no tenemos en el dataset. Este es un claro ejemplo. En este caso, al disponer de la encuesta entera hemos detectado que estos mnar est√°n relacionados con no haber votado en las √∫ltimas elecciones, lo cual viene recogido en otra variable de la encuesta que no est√° incluida en nuestro dataset.
:::

#### Imputaci√≥n Cualis < 5%

```{r}
prop.table(table(data_num$NIVELESTENTREV,useNA = "always"))
#sustituimos los NAs por el valor mas repetido, la moda
data_num$NIVELESTENTREV_imp <-data_num$NIVELESTENTREV
data_num$NIVELESTENTREV_imp[is.na(data_num$NIVELESTENTREV_imp)] <-
  "Licenciatura"


prop.table(table(data_num$GRADACDISC,useNA = "always"))
#sustituimos los NAs por el valor mas repetido, la moda
data_num$GRADACDISC_imp <-data_num$GRADACDISC
data_num$GRADACDISC_imp[is.na(data_num$GRADACDISC_imp)] <-
  "Nada de acuerdo"


prop.table(table(data_num$GRADODESIGUALDAD,useNA = "always"))
#sustituimos los NAs por el valor mas repetido, la moda
data_num$GRADODESIGUALDAD_imp <-data_num$GRADODESIGUALDAD
data_num$GRADODESIGUALDAD_imp[is.na(data_num$GRADODESIGUALDAD_imp)] <-
  "Bastante grandes"


prop.table(table(data_num$VALSALARIOS,useNA = "always"))
#sustituimos los NAs por el valor mas repetido, la moda
data_num$VALSALARIOS_imp <-data_num$VALSALARIOS
data_num$VALSALARIOS_imp[is.na(data_num$VALSALARIOS_imp)] <-
  "Peor"


prop.table(table(data_num$VALPOSASC,useNA = "always"))
#sustituimos los NAs por el valor mas repetido, la moda
data_num$VALPOSASC_imp <-data_num$VALPOSASC
data_num$VALPOSASC_imp[is.na(data_num$VALPOSASC_imp)] <-
  "Peor"


prop.table(table(data_num$VALOPEMP,useNA = "always"))
#sustituimos los NAs por el valor mas repetido, la moda
data_num$VALOPEMP_imp <-data_num$VALOPEMP
data_num$VALOPEMP_imp[is.na(data_num$VALOPEMP_imp)] <-
  "Peor"
```

```{r}
vis_miss(data_num)
```

- Aqu√≠ vemos como la imputaci√≥n por la moda para estas variables cualitativas a funcionado pues ninguna de las imputadas presenta ning√∫n ausente en el vis_miss.

### An√°lisis de cuantitativas

#### Visualizamos

```{r}
marginplot(data_num[c("EDAD","TARHOGENTREV_HH")])
ggplot(data = data_num, aes (x = EDAD, y = TARHOGENTREV_HH )) + geom_miss_point()

ggplot(data = data_num, aes (x = CUIDADOHIJOS_HH , y = TARHOGENTREV_HH )) + geom_miss_point()
marginplot(data_num[c("CUIDADOHIJOS_HH","TARHOGENTREV_HH")])

ggplot(data = data_num, aes (x = ESCFEMINIS  , y = TARHOGENTREV_HH )) + geom_miss_point()
marginplot(data_num[c("ESCFEMINIS","TARHOGENTREV_HH")])

ggplot(data = data_num, aes (x = ESCIDEOL   , y = TARHOGENTREV_HH )) + geom_miss_point()
marginplot(data_num[c("ESCIDEOL","TARHOGENTREV_HH")])
```

- Tras la elaboraci√≥n de los gr√°ficos correspondientes a las tres variables continuas analizadas, se ha llegado a una conclusi√≥n com√∫n: los datos faltantes en estas variables parecen corresponderse con un mecanismo de tipo **MCAR** (*Missing Completely At Random*). Esta conclusi√≥n se fundamenta en que no se observa una relaci√≥n evidente entre la ausencia de datos y otras variables del conjunto; es decir, los datos faltantes son independientes del resto de la informaci√≥n disponible.

- Esta independencia se evidencia claramente en los **margin plots**, donde los **boxplots** se mantienen a una altura similar en las comparaciones, indicando que la distribuci√≥n de los valores observados no cambia en funci√≥n de la presencia o ausencia de datos. Aunque en algunos gr√°ficos pueden percibirse ligeras asociaciones, un an√°lisis m√°s detallado revela que estas se deben a una mayor concentraci√≥n general de observaciones en ciertas zonas del gr√°fico, y no a una relaci√≥n directa con la falta de datos. Por lo tanto, concluimos que no existe una asociaci√≥n sistem√°tica que explique los valores faltantes.

- Como estamos con variables continuas con un un bajo % de missings vamos a imputar por la media.

#### Imputaci√≥n cuantis

```{r}
#TARHOGENTREV_HH_media
data_num$TARHOGENTREV_HH_media <- ifelse(
  is.na(data_num$TARHOGENTREV_HH),
  mean(data_num$TARHOGENTREV_HH, na.rm = TRUE),
  data_num$TARHOGENTREV_HH
)
#ESCIDEOL_media
data_num$ESCIDEOL_media<-data_num$ESCIDEOL
mean(data_num$ESCIDEOL, na.rm = TRUE)

data_num$ESCIDEOL_media[is.na(data_num$ESCIDEOL_media)] <- mean(data_num$ESCIDEOL_media, na.rm = TRUE)

#ESCFEMINIS_media
data_num$ESCFEMINIS_MEDIA<-data_num$ESCFEMINIS
mean(data_num$ESCFEMINIS, na.rm = TRUE)

data_num$ESCFEMINIS_MEDIA[is.na(data_num$ESCFEMINIS_MEDIA)] <- 
  mean(data_num$ESCFEMINIS_MEDIA, na.rm = TRUE)


```

- Vemos si se ajusta bien a la distribucion

```{r}
#TARHOGENTREV_HH

ggplot(data_num) + geom_density(aes(x = TARHOGENTREV_HH, fill = "Original"), alpha = 0.5) + geom_density(aes(x = TARHOGENTREV_HH_media, fill = "Imputado"), alpha = 0.5) + scale_fill_manual(values = c("Original" = "blue", "Imputado" = "red")) + labs(title = "Comparaci√≥n de densidades: Original vs. Imputado", x = "TARHOGENTREV_HH", y = "Densidad", fill = "Tipo de dato") + theme_minimal()

#ESCFEMINIS
ggplot(data_num, aes(x = ESCFEMINIS, fill = "Age")) +
geom_density(alpha = 0.5) +
geom_density(aes(x = ESCFEMINIS_MEDIA, fill = "Age_media"),alpha=0.5)

#ESCIDEOL
ggplot(data_num, aes(x = ESCIDEOL, fill = "ESCIDEOL")) +
geom_density(alpha = 0.5) +
geom_density(aes(x = ESCIDEOL_media, fill = "ESCIDEOL_media"),alpha=0.5)

```

- En los gr√°ficos presentados se comparan las distribuciones originales de las variables con las distribuciones resultantes tras la imputaci√≥n. Se observa que, en todo momento, ambas se ajustan de forma bastante precisa, lo que indica que el proceso de imputaci√≥n ha sido adecuado. Las imputaciones realizadas no alteran significativamente el comportamiento ni la forma de la distribuci√≥n original, lo cual sugiere que los valores imputados mantienen la coherencia con los datos observados y no introducen sesgos visibles en la estructura de los datos.

### Imputaci√≥n M√∫ltiple

>Las variables cualitativas con un porcentaje de valores perdidos superior al 5% ser√°n imputadas mediante el algoritmo MICE (Multiple Imputation by Chained Equations), dado que permite una imputaci√≥n adecuada respetando la naturaleza categ√≥rica de los datos.

```{r}
metodos <- c(
  SEXO = "", 
  EDAD = "", 
  TAMUNI = "", 
  INGRESHOG = "cart", 
  TARHOGENTREV_HH = "", 
  HIJOMENOR = "", 
  SITLAB = "", 
  NIVELESTENTREV = "", 
  GRADACDISC = "", 
  GRADODESIGUALDAD = "", 
  VALSALARIOS = "", 
  VALPOSASC = "", 
  VALOPEMP = "", 
  ESCFEMINIS = "", 
  ESCIDEOL = "", 
  RELIGION = "",
  RECUVOTOG = "cart"
)
```

```{r}
impData <- mice(data_num |> select(
  -NIVELESTENTREV_imp,
  -GRADACDISC_imp,
  -GRADODESIGUALDAD_imp,
  -VALSALARIOS_imp,
  -VALPOSASC_imp,
  -VALOPEMP_imp,
  -TARHOGENTREV_HH_media,
  -ESCIDEOL_media,
  -ESCFEMINIS_MEDIA,
  -CUIDADOHIJOS_HH), m = 5, maxit = 50, seed = 500, method = metodos)
```



#### Visualizamos

```{r}
##Complete Data
completeData <- complete(impData, 1)
```

```{r}
# Graficar la distribuci√≥n de la variable categ√≥rica antes y despu√©s de la imputaci√≥n
par(mfrow = c(1, 2)) # Organizar las gr√°ficas en una fila de 2 columnas
barplot(table(data_num$INGRESHOG, useNA = "ifany"), main = "Antes de la imputaci√≥n")
barplot(table(completeData$INGRESHOG), main = "Despu√©s de la imputaci√≥n")
```

```{r}
# Graficar la distribuci√≥n de la variable categ√≥rica antes y despu√©s de la imputaci√≥n
par(mfrow = c(1, 2)) # Organizar las gr√°ficas en una fila de 2 columnas
barplot(table(data_num$RECUVOTOG, useNA = "ifany"), main = "Antes de la imputaci√≥n")
barplot(table(completeData$RECUVOTOG), main = "Despu√©s de la imputaci√≥n")
```

- As√≠ es como nos quedar√≠a la variable imputada. Vemos que no estamos distorsionando su distribuci√≥n. Basatante bien.

## BASE DE DATOS DEPURADA üßπ

```{r}
write.csv(data_num, "base_depurada.csv", row.names = FALSE)
write.csv(completeData, "base_depurada_mice.csv", row.names = FALSE) #mice
```

